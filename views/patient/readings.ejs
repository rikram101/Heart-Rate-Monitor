<% layout('layouts/bootstrap')%>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-primary">My Health Data</h1>

    <div class="d-flex gap-3">
      <select id="viewSelector" class="form-select w-auto">
        <option value="detailed">Detailed Daily View</option>
        <option value="summary">Weekly Summary</option>
      </select>

      <input type="date" id="datePicker" class="form-control w-auto" />
    </div>
  </div>

  <div id="summarySection" class="d-none">
    <div class="alert alert-info">
      <h4 class="alert-heading">Weekly Overview (Last 7 Days)</h4>
      <p class="mb-0">Aggregated statistics from all your devices.</p>
    </div>

    <div class="row text-center">
      <div class="col-md-6 mb-3">
        <div class="card shadow-sm border-danger h-100">
          <div class="card-header bg-danger text-white">Heart Rate (BPM)</div>
          <div class="card-body">
            <h2 class="display-4" id="avgHeartRate">--</h2>
            <p class="text-muted">7-Day Average</p>
            <hr />
            <div class="d-flex justify-content-around">
              <div>
                <span class="fw-bold text-success">Min</span>
                <div id="minHeartRate" class="h5">--</div>
              </div>
              <div>
                <span class="fw-bold text-danger">Max</span>
                <div id="maxHeartRate" class="h5">--</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6 mb-3">
        <div class="card shadow-sm border-primary h-100">
          <div class="card-header bg-primary text-white">
            Blood Oxygen (SpO2 %)
          </div>
          <div class="card-body">
            <h2 class="display-4" id="avgSpo2">--</h2>
            <p class="text-muted">7-Day Average</p>
            <hr />
            <div class="d-flex justify-content-around">
              <div>
                <span class="fw-bold text-warning">Min</span>
                <div id="minSpo2" class="h5">--</div>
              </div>
              <div>
                <span class="fw-bold text-success">Max</span>
                <div id="maxSpo2" class="h5">--</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="detailedSection">
    <div class="row">
      <div class="col-12 mb-5">
        <div class="card shadow">
          <div class="card-header bg-white">
            <h5 class="card-title text-danger mb-0">‚ù§Ô∏è Heart Rate Timeline</h5>
          </div>
          <div class="card-body">
            <canvas id="heartRateChart" height="100"></canvas>
          </div>
        </div>
      </div>

      <div class="col-12 mb-5">
        <div class="card shadow">
          <div class="card-header bg-white">
            <h5 class="card-title text-primary mb-0">
              üíß Blood Oxygen (SpO2) Timeline
            </h5>
          </div>
          <div class="card-body">
            <canvas id="spo2Chart" height="100"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Initialize elements
  const viewSelector = document.getElementById("viewSelector");
  const datePicker = document.getElementById("datePicker");
  const summarySection = document.getElementById("summarySection");
  const detailedSection = document.getElementById("detailedSection");

  // Set Date Picker to Today
  datePicker.valueAsDate = new Date();

  // Chart Instances (to destroy/recreate later)
  let heartRateChartInstance = null;
  let spo2ChartInstance = null;

  // --- EVENT LISTENERS ---

  // 1. Switch Views
  viewSelector.addEventListener("change", (e) => {
    if (e.target.value === "summary") {
      detailedSection.classList.add("d-none");
      summarySection.classList.remove("d-none");
      datePicker.classList.add("d-none"); // Hide date picker for summary
      loadSummaryData();
    } else {
      summarySection.classList.add("d-none");
      detailedSection.classList.remove("d-none");
      datePicker.classList.remove("d-none");
      loadDetailedData(datePicker.value);
    }
  });

  // 2. Change Date (Detailed View)
  datePicker.addEventListener("change", (e) => {
    loadDetailedData(e.target.value);
  });

  // Initial Load
  loadDetailedData(datePicker.value);

  // --- FUNCTION: LOAD WEEKLY SUMMARY ---
  async function loadSummaryData() {
    try {
      const res = await fetch("/patient/readings/summary");
      const data = await res.json();

      if (data.success && data.summary) {
        const s = data.summary;
        // Update DOM elements
        document.getElementById("avgHeartRate").innerText = Math.round(
          s.heartRate.avg || 0
        );
        document.getElementById("minHeartRate").innerText =
          s.heartRate.min || "-";
        document.getElementById("maxHeartRate").innerText =
          s.heartRate.max || "-";

        document.getElementById("avgSpo2").innerText =
          Math.round(s.spo2.avg || 0) + "%";
        document.getElementById("minSpo2").innerText =
          (s.spo2.min || "-") + "%";
        document.getElementById("maxSpo2").innerText =
          (s.spo2.max || "-") + "%";
      }
    } catch (err) {
      console.error("Failed to load summary", err);
    }
  }

  // --- FUNCTION: LOAD DETAILED CHARTS ---
  async function loadDetailedData(dateString) {
    try {
      const res = await fetch(`/patient/readings/daily?date=${dateString}`);
      const json = await res.json();

      if (json.success) {
        renderCharts(json.data.heartRate, json.data.spo2);
      }
    } catch (err) {
      console.error("Failed to load daily charts", err);
    }
  }

  // --- FUNCTION: RENDER CHARTS WITH CHART.JS ---
  function renderCharts(hrData, spo2Data) {
    // Destroy existing charts if they exist to prevent overlap
    if (heartRateChartInstance) heartRateChartInstance.destroy();
    if (spo2ChartInstance) spo2ChartInstance.destroy();

    // 1. Heart Rate Chart Configuration
    const ctxHR = document.getElementById("heartRateChart").getContext("2d");
    heartRateChartInstance = new Chart(ctxHR, {
      type: "line",
      data: {
        datasets: [
          {
            label: "Heart Rate (BPM)",
            data: hrData, // Expects {x: time, y: value} format
            borderColor: "#dc3545",
            backgroundColor: "rgba(220, 53, 69, 0.1)",
            borderWidth: 2,
            pointRadius: 3,
            fill: true,
            tension: 0.3, // Smooth curves
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: "time", // Requires chartjs-adapter-date-fns
            time: {
              unit: "hour",
              displayFormats: { hour: "HH:mm" },
            },
            title: { display: true, text: "Time of Day" },
          },
          y: {
            title: { display: true, text: "BPM" },
            suggestedMin: 40,
            suggestedMax: 120,
          },
        },
      },
    });

    // 2. SpO2 Chart Configuration
    const ctxSpo2 = document.getElementById("spo2Chart").getContext("2d");
    spo2ChartInstance = new Chart(ctxSpo2, {
      type: "line",
      data: {
        datasets: [
          {
            label: "SpO2 (%)",
            data: spo2Data,
            borderColor: "#0d6efd",
            backgroundColor: "rgba(13, 110, 253, 0.1)",
            borderWidth: 2,
            pointRadius: 3,
            fill: true,
            tension: 0.3,
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: "time",
            time: {
              unit: "hour",
              displayFormats: { hour: "HH:mm" },
            },
            title: { display: true, text: "Time of Day" },
          },
          y: {
            title: { display: true, text: "Percentage (%)" },
            min: 80, // SpO2 is usually 95-100, dropping below 80 is rare/critical
            max: 100,
          },
        },
      },
    });
  }
</script>
